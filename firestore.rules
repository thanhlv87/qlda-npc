rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS (Sử dụng cú pháp đã được kiểm chứng, ổn định) ---
    function isAdmin() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid))
             && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }
    function isDepartmentHead() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid))
             && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'DepartmentHead';
    }
    // Gộp Admin và Trưởng phòng để dễ sử dụng
    function isPrivilegedUser() {
      return isAdmin() || isDepartmentHead();
    }

    // Helper function kiểm tra PM cho một dự án cụ thể (dùng cho Quản lý Tài liệu)
    function isProjectManagerForProject(projectId) {
        return exists(/databases/$(database)/documents/projects/$(projectId))
               && request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.projectManagerIds;
    }

    // --- COLLECTION RULES ---

    // Rules for 'users' collection (Lấy từ quy tắc đang hoạt động của bạn)
    match /users/{userId} {
      allow create: if request.auth != null && request.auth.uid == userId && request.resource.data.role == null;
      allow read: if isAdmin() || request.auth.uid == userId;
      allow update, delete: if isAdmin();

      // Notifications subcollection - NEW for notification system
      match /notifications/{notificationId} {
        // Users can read their own notifications
        allow read: if request.auth != null && request.auth.uid == userId;

        // Users can update/delete their own notifications (mark as read, delete)
        allow update, delete: if request.auth != null && request.auth.uid == userId;

        // Cloud Functions can create notifications (using service account)
        // Also allow authenticated users to create (for manual testing)
        allow create: if request.auth != null;
      }
    }

    // Rules for 'projects' collection (Lấy từ quy tắc đang hoạt động của bạn)
    match /projects/{projectId} {
      allow read: if isPrivilegedUser() ||
                    (request.auth.uid in resource.data.projectManagerIds) ||
                    (request.auth.uid in resource.data.leadSupervisorIds);
      allow create: if isPrivilegedUser();
      allow update: if isPrivilegedUser() || (request.auth.uid in resource.data.projectManagerIds);
      allow delete: if isAdmin();
    }

    // Rules for 'reports' collection (Lấy từ quy tắc đang hoạt động của bạn)
    match /reports/{reportId} {
      // READ rule dùng `resource.data` để truy cập document đang được đọc.
      allow read: if isPrivilegedUser() ||
                    (exists(/databases/$(database)/documents/projects/$(resource.data.projectId)) &&
                     (request.auth.uid in get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.projectManagerIds ||
                      request.auth.uid in get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.leadSupervisorIds));

      // CREATE rule dùng `request.resource.data` để truy cập document sắp được tạo.
      allow create: if exists(/databases/$(database)/documents/projects/$(request.resource.data.projectId)) &&
                     (request.auth.uid in get(/databases/$(database)/documents/projects/$(request.resource.data.projectId)).data.projectManagerIds ||
                      request.auth.uid in get(/databases/$(database)/documents/projects/$(request.resource.data.projectId)).data.leadSupervisorIds);

      allow update, delete: if isAdmin();
    }

    // --- NEW: Rules for project document subcollections (Phần bổ sung để chạy Quản lý Tài liệu) ---

    match /projects/{projectId}/files/{fileId} {
        // Cho phép list, read, create, delete cho Admin, Trưởng phòng, và PM được gán
        allow list, read, create, delete: if isPrivilegedUser() || isProjectManagerForProject(projectId);
    }

    match /projects/{projectId}/folders/{folderId} {
        // Cho phép list, read, create, delete cho Admin, Trưởng phòng, và PM được gán
        allow list, read, create, delete: if isPrivilegedUser() || isProjectManagerForProject(projectId);
    }
  }
}
